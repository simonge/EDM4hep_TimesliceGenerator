name: Build against eic-shell

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  XROOTD_SERVER: root://dtn-eic.jlab.org/
  HEPMC3_PATH: /volatile/eic/EPIC/EVGEN/
  HEPMC3_SIGNAL_PATH: DIS/NC/18x275/minQ2=1000/pythia8NCDIS_18x275_minQ2=1000_beamEffects_xAngle=-0.025_hiDiv_1.hepmc3.tree.root
  HEPMC3_MINBIAS_PATH: SIDIS/pythia6-eic/1.0.0/18x275/q2_0to1/pythia_ep_noradcor_18x275_q2_0.000000001_1.0_run1.ab.hepmc3.tree.root
  HEPMC3_HADRON_BEAMGAS_PATH: BACKGROUNDS/BEAMGAS/proton/pythia8.306-1.0/275GeV/pythia8.306-1.0_ProtonBeamGas_275GeV_run001.hepmc3.tree.root
  HEPMC3_ELECTRON_BEAMGAS_BREMS_PATH: BACKGROUNDS/BEAMGAS/electron/brems/EIC_ESR_Xsuite/dataprod_rel_1.0.1/18x275/10000Ahr/MachineRuntime50s/dataprod_rel_1.0.1_electron_brems_18x275_10000Ahr.hepmc3.tree.root
  HEPMC3_ELECTRON_BEAMGAS_COULOMB_PATH: BACKGROUNDS/BEAMGAS/electron/coulomb/EIC_ESR_Xsuite/dataprod_rel_1.0.1/18x275/10000Ahr/MachineRuntime50s/dataprod_rel_1.0.1_electron_coulomb_18x275_10000Ahr.hepmc3.tree.root
  HEPMC3_ELECTRON_BEAMGAS_TOUSCHEK_PATH: BACKGROUNDS/BEAMGAS/electron/touschek/EIC_ESR_Xsuite/dataprod_rel_1.0.1/18x275/10000Ahr/MachineRuntime50s/dataprod_rel_1.0.1_electron_touschek_18x275_10000Ahr.hepmc3.tree.root
  HEPMC3_ELECTRON_SYNCHROTRON_PATH: BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.hepmc3.tree.root

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Build and install
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          # Build the project
          ./make.sh
    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: timeframe-builder-binaries
        path: |
          install/
          configs/
        retention-days: 1

  epic-simulations:
    needs: build
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Run all EPIC simulations with Snakemake
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          source /opt/detector/epic-main/bin/thisepic.sh
          snakemake --cores 1
    - name: Upload all EPIC simulation outputs
      uses: actions/upload-artifact@v4
      with:
        name: epic-simulated-separate
        path: |
          epic_sim_ci_signal.edm4hep.root
          epic_sim_ci_minbias.edm4hep.root
          epic_sim_ci_hadron_beamgas.edm4hep.root
          epic_sim_ci_electron_beamgas_brems.edm4hep.root
          epic_sim_ci_electron_beamgas_coulomb.edm4hep.root
          epic_sim_ci_electron_beamgas_touschek.edm4hep.root
          epic_sim_ci_electron_synchrotron.edm4hep.root
        retention-days: 1

  test-edm4hep:
    needs: epic-simulations
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: timeframe-builder-binaries
    - name: Fix binary permissions
      run: chmod +x install/bin/timeframe_builder
    - name: Download separate EPIC simulation output
      uses: actions/download-artifact@v4
      with:
        name: epic-simulated-separate
    - name: EDM4hep merging from simulation outputs
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          # EDM4hep smoke test using built binary
          ./install/bin/timeframe_builder --config configs/config_ci.yml \
            --output merged_ci_18x275.edm4hep.root \
            --source:signal:input_files epic_sim_ci_signal.edm4hep.root \
            --source:minbias:input_files epic_sim_ci_minbias.edm4hep.root \
            --source:hadron_beamgas:input_files epic_sim_ci_hadron_beamgas.edm4hep.root \
            --source:electron_beamgas_brems:input_files epic_sim_ci_electron_beamgas_brems.edm4hep.root \
            --source:electron_beamgas_coulomb:input_files epic_sim_ci_electron_beamgas_coulomb.edm4hep.root \
            --source:electron_beamgas_touschek:input_files epic_sim_ci_electron_beamgas_touschek.edm4hep.root \
            --source:electron_synchrotron:input_files epic_sim_ci_electron_synchrotron.edm4hep.root
          
          ls -lh merged_ci_18x275.edm4hep.root
    - name: Upload EDM4hep merger output
      uses: actions/upload-artifact@v6
      with:
        name: edm4hep-merged
        path: merged_ci_18x275.edm4hep.root
        retention-days: 1

  test-hepmc3:
    needs: build
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: timeframe-builder-binaries
    - name: Fix binary permissions
      run: chmod +x install/bin/timeframe_builder
    - name: HepMC3 merging from XRootD
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          # HepMC3 smoke test using built binary
          ./install/bin/timeframe_builder --config configs/config_ci.yml \
            --output merged_ci_18x275.hepmc3.tree.root \
            --source:signal:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_SIGNAL_PATH}} \
            --source:minbias:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_MINBIAS_PATH}} \
            --source:hadron_beamgas:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_HADRON_BEAMGAS_PATH}} \
            --source:electron_beamgas_brems:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_ELECTRON_BEAMGAS_BREMS_PATH}} \
            --source:electron_beamgas_coulomb:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_ELECTRON_BEAMGAS_COULOMB_PATH}} \
            --source:electron_beamgas_touschek:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_ELECTRON_BEAMGAS_TOUSCHEK_PATH}} \
            --source:electron_synchrotron:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_ELECTRON_SYNCHROTRON_PATH}}
          
          ls -lh merged_ci_18x275.hepmc3.tree.root
    - name: Upload HepMC3 merger output
      uses: actions/upload-artifact@v6
      with:
        name: hepmc3-merged
        path: merged_ci_18x275.hepmc3.tree.root
        retention-days: 1

  merged-epic-simulation:
    needs: test-hepmc3
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download build binaries
      uses: actions/download-artifact@v7
      with:
        name: timeframe-builder-binaries
    - name: Download HepMC3 events
      uses: actions/download-artifact@v7
      with:
        name: hepmc3-merged
    - name: Run EPIC simulation on HepMC3 output
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          source /opt/detector/epic-main/bin/thisepic.sh
          # Run npsim on the merged HepMC3 events
          npsim --compactFile $DETECTOR_PATH/epic_craterlake.xml \
                --inputFiles merged_ci_18x275.hepmc3.tree.root \
                --outputFile sim_ci_18x275.edm4hep.root \
                --numberOfEvents 10
          
          ls -lh sim_ci_18x275.edm4hep.root
    - name: Upload simulated events
      uses: actions/upload-artifact@v6
      with:
        name: epic-simulated
        path: sim_ci_18x275.edm4hep.root
        retention-days: 1

  eicrecon-from-epic:
    needs: merged-epic-simulation
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download EPIC simulated events
      uses: actions/download-artifact@v7
      with:
        name: epic-simulated
    - name: Run eicrecon on simulated events
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          source /opt/detector/epic-main/bin/thisepic.sh
          # Run eicrecon on simulated events from EPIC simulation
          eicrecon -Pplugins=dump_flags sim_ci_18x275.edm4hep.root -Pjana:loglevel=info -Pjana:warmup_timeout=0 -Pjana:timeout=0 -Ppodio:output_file=recon_ci_18x275_from_epic.eicrecon.edm4eic.root
          
          ls -lh recon_ci_18x275_from_epic.eicrecon.edm4eic.root 2>/dev/null || echo "Warning: eicrecon output not found"
    - name: Upload reconstructed events
      uses: actions/upload-artifact@v6
      with:
        name: epic-reconstructed
        path: recon_ci_18x275_from_epic.eicrecon.edm4eic.root
        retention-days: 1

  eicrecon-from-edm4hep:
    needs: test-edm4hep
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download EDM4hep merged events
      uses: actions/download-artifact@v7
      with:
        name: edm4hep-merged
    - name: Verify file exists
      run: |
        pwd
        ls -lh
        ls -lh merged_ci_18x275.edm4hep.root
        file merged_ci_18x275.edm4hep.root
    - name: Run eicrecon on EDM4hep merged events
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          source /opt/detector/epic-main/bin/thisepic.sh
          # Verify file exists
          ls -lh merged_ci_18x275.edm4hep.root
          # Run eicrecon directly on merged EDM4hep events
          eicrecon -Pplugins=dump_flags merged_ci_18x275.edm4hep.root -Pjana:loglevel=info -Pjana:warmup_timeout=0 -Pjana:timeout=0 -Ppodio:output_file=recon_ci_18x275_from_edm4hep.eicrecon.edm4eic.root
          
          ls -lh recon_ci_18x275_from_edm4hep.eicrecon.edm4eic.root 2>/dev/null || echo "Warning: eicrecon output not found"
    - name: Upload reconstructed events
      uses: actions/upload-artifact@v6
      with:
        name: edm4hep-reconstructed
        path: recon_ci_18x275_from_edm4hep.eicrecon.edm4eic.root
        retention-days: 1

  capybara-report:
    runs-on: ubuntu-24.04
    needs: 
      - eicrecon-from-edm4hep
      - eicrecon-from-epic
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download epic eicrecon outputs
      uses: actions/download-artifact@v7
      with:
        name: epic-reconstructed
    - name: Download edm4hep eicrecon outputs
      uses: actions/download-artifact@v7
      with:
        name: edm4hep-reconstructed
    - name: Generate Capybara report
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          mkdir capybara-reports
          capybara bara recon_ci_18x275_from_epic.eicrecon.edm4eic.root recon_ci_18x275_from_edm4hep.eicrecon.edm4eic.root
          mv capybara-reports timeslice_builder_comparison
    - name: Upload Capybara report
      uses: actions/upload-artifact@v6
      with:
        name: capybara-report
        path: timeslice_builder_comparison
        retention-days: 1
        
  collect-docs:
    runs-on: ubuntu-24.04
    needs: capybara-report
    steps:
      - name: Download capybara report
        uses: actions/download-artifact@v7
        with:
          name: capybara-report
          path: publishing_docs/capybara/timeslice_builder_comparison
      - name: Create capybara index
        run: |
          echo "# TimesliceBuilder Capybara Reports" > publishing_docs/capybara/index.md
          echo "" >> publishing_docs/capybara/index.md
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### Capybara summary for PR ${{ github.event.pull_request.number }}" >> publishing_docs/capybara/index.md
          else
            echo "### Capybara summary for main" >> publishing_docs/capybara/index.md
          fi
          echo "" >> publishing_docs/capybara/index.md
          find publishing_docs/capybara/ -mindepth 1 -maxdepth 1 -type d -printf \
            "- [%f](timeslice_builder_comparison/index.html)\n" | sort >> publishing_docs/capybara/index.md
      - name: List content to publish
        run: find publishing_docs/
      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: publishing_docs/
          retention-days: 7
      - name: Create capybara step summary
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### Capybara Report for PR ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [View Report](https://timeslicegenerator.epic-eic.org/capybara/timeslice_builder_comparison/index.html)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Capybara Report for main" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [View Report](https://timeslicegenerator.epic-eic.org/capybara/timeslice_builder_comparison/index.html)" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-docs:
    needs: collect-docs
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-24.04
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4