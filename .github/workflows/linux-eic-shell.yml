name: Build against eic-shell

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  XROOTD_SERVER: root://dtn-eic.jlab.org/
  HEPMC3_PATH: /volatile/eic/EPIC/EVGEN/
  EDM4HEP_PATH: /volatile/eic/EPIC/FULL/25.12.0/epic_craterlake/
  HEPMC3_SIGNAL_PATH: DIS/NC/18x275/minQ2=1000/pythia8NCDIS_18x275_minQ2=1000_beamEffects_xAngle=-0.025_hiDiv_1.hepmc3.tree.root
  HEPMC3_MINBIAS_PATH: SIDIS/pythia6-eic/1.0.0/18x275/q2_0to1/pythia_ep_noradcor_18x275_q2_0.000000001_1.0_run1.ab.hepmc3.tree.root
  HEPMC3_HADRON_BEAMGAS_PATH: BACKGROUNDS/BEAMGAS/proton/pythia8.306-1.0/275GeV/pythia8.306-1.0_ProtonBeamGas_275GeV_run001.hepmc3.tree.root
  HEPMC3_ELECTRON_BEAMGAS_BREMS_PATH: BACKGROUNDS/BEAMGAS/electron/brems/EIC_ESR_Xsuite/dataprod_rel_1.0.1/18x275/10000Ahr/MachineRuntime50s/dataprod_rel_1.0.1_electron_brems_18x275_10000Ahr.hepmc3.tree.root
  HEPMC3_ELECTRON_BEAMGAS_COULOMB_PATH: BACKGROUNDS/BEAMGAS/electron/coulomb/EIC_ESR_Xsuite/dataprod_rel_1.0.1/18x275/10000Ahr/MachineRuntime50s/dataprod_rel_1.0.1_electron_coulomb_18x275_10000Ahr.hepmc3.tree.root
  HEPMC3_ELECTRON_BEAMGAS_TOUSCHEK_PATH: BACKGROUNDS/BEAMGAS/electron/touschek/EIC_ESR_Xsuite/dataprod_rel_1.0.1/18x275/10000Ahr/MachineRuntime50s/dataprod_rel_1.0.1_electron_touschek_18x275_10000Ahr.hepmc3.tree.root
  HEPMC3_ELECTRON_SYNCHROTRON_PATH: BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.hepmc3.tree.root
  EDM4HEP_SIGNAL_PATH: DIS/NC/18x275/minQ2=1000/pythia8NCDIS_18x275_minQ2=1000_beamEffects_xAngle=-0.025_hiDiv_1.0074.edm4hep.root
  EDM4HEP_MINBIAS_PATH: DIS/NC/18x275/minQ2=1/pythia8NCDIS_18x275_minQ2=1_beamEffects_xAngle=-0.025_hiDiv_1.0074.edm4hep.root
  EDM4HEP_HADRON_BEAMGAS_PATH: BACKGROUNDS/BEAMGAS/proton/pythia8.306-1.0/275GeV/pythia8.306-1.0_ProtonBeamGas_275GeV_run001.0000.edm4hep.root
  EDM4HEP_ELECTRON_BEAMGAS_BREMS_PATH: BACKGROUNDS/BEAMGAS/electron/GETaLM1.0.0-1.1/18GeV/GETaLM1.0.0-1.1_ElectronBeamGas_18GeV_emin10keV_run001.0000.edm4hep.root
  EDM4HEP_ELECTRON_BEAMGAS_COULOMB_PATH: BACKGROUNDS/BEAMGAS/electron/coulomb/EIC_ESR_Xsuite/dataprod_rel_1.0.1/18x275/10000Ahr/MachineRuntime50s/dataprod_rel_1.0.1_electron_coulomb_18x275_10000Ahr.0000.edm4hep.root
  EDM4HEP_ELECTRON_BEAMGAS_TOUSCHEK_PATH: BACKGROUNDS/BEAMGAS/electron/touschek/EIC_ESR_Xsuite/dataprod_rel_1.0.1/18x275/10000Ahr/MachineRuntime50s/dataprod_rel_1.0.1_electron_touschek_18x275_10000Ahr.0000.edm4hep.root
  EDM4HEP_ELECTRON_SYNCHROTRON_PATH: BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0000.edm4hep.root,BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0001.edm4hep.root,BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0002.edm4hep.root,BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0003.edm4hep.root,BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0004.edm4hep.root,BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0005.edm4hep.root,BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0006.edm4hep.root,BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0007.edm4hep.root,BACKGROUNDS/SYNRAD/dataprod_rel_1.0.0/18x275/dataprod_rel_1.0.0_synrad_18x275_run001.preproc_10000repeats.0008.edm4hep.root

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Build and install
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          # Build the project
          ./make.sh
    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: timeframe-builder-binaries
        path: |
          install/
          configs/
        retention-days: 1

  test-edm4hep:
    needs: build
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: timeframe-builder-binaries
    - name: Fix binary permissions
      run: chmod +x install/bin/timeframe_builder
    - name: EDM4hep merging from XRootD
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          # EDM4hep smoke test using built binary
          ./install/bin/timeframe_builder --config configs/config_ci.yml \
            --output merged_ci_18x275.edm4hep.root \
            --source:signal:input_files ${{env.XROOTD_SERVER}}${{env.EDM4HEP_PATH}}${{env.EDM4HEP_SIGNAL_PATH}} \
            --source:minbias:input_files ${{env.XROOTD_SERVER}}${{env.EDM4HEP_PATH}}${{env.EDM4HEP_MINBIAS_PATH}} \
            --source:hadron_beamgas:input_files ${{env.XROOTD_SERVER}}${{env.EDM4HEP_PATH}}${{env.EDM4HEP_HADRON_BEAMGAS_PATH}} \
            --source:electron_beamgas_bremsstrahlung:input_files ${{env.XROOTD_SERVER}}${{env.EDM4HEP_PATH}}${{env.EDM4HEP_ELECTRON_BEAMGAS_BREMS_PATH}} \
            --source:electron_beamgas_coulomb:input_files ${{env.XROOTD_SERVER}}${{env.EDM4HEP_PATH}}${{env.EDM4HEP_ELECTRON_BEAMGAS_COULOMB_PATH}} \
            --source:electron_beamgas_touschek:input_files ${{env.XROOTD_SERVER}}${{env.EDM4HEP_PATH}}${{env.EDM4HEP_ELECTRON_BEAMGAS_TOUSCHEK_PATH}} \
            --source:electron_synchrotron:input_files ${{env.XROOTD_SERVER}}${{env.EDM4HEP_PATH}}${{env.EDM4HEP_ELECTRON_SYNCHROTRON_PATH}}
          
          ls -lh merged_ci_18x275.edm4hep.root
    - name: Upload EDM4hep merger output
      uses: actions/upload-artifact@v6
      with:
        name: edm4hep-merged
        path: merged_ci_18x275.edm4hep.root
        retention-days: 1

  test-hepmc3:
    needs: build
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: timeframe-builder-binaries
    - name: Fix binary permissions
      run: chmod +x install/bin/timeframe_builder
    - name: HepMC3 merging from XRootD
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          # HepMC3 smoke test using built binary
          ./install/bin/timeframe_builder --config configs/config_ci.yml \
            --output merged_ci_18x275.hepmc3.tree.root \
            --source:signal:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_SIGNAL_PATH}} \
            --source:minbias:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_MINBIAS_PATH}} \
            --source:hadron_beamgas:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_HADRON_BEAMGAS_PATH}} \
            --source:electron_beamgas_bremsstrahlung:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_ELECTRON_BEAMGAS_BREMS_PATH}} \
            --source:electron_beamgas_coulomb:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_ELECTRON_BEAMGAS_COULOMB_PATH}} \
            --source:electron_beamgas_touschek:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_ELECTRON_BEAMGAS_TOUSCHEK_PATH}} \
            --source:electron_synchrotron:input_files ${{env.XROOTD_SERVER}}${{env.HEPMC3_PATH}}${{env.HEPMC3_ELECTRON_SYNCHROTRON_PATH}}
          
          ls -lh merged_ci_18x275.hepmc3.tree.root
    - name: Upload HepMC3 merger output
      uses: actions/upload-artifact@v6
      with:
        name: hepmc3-merged
        path: merged_ci_18x275.hepmc3.tree.root
        retention-days: 1

  epic-simulation:
    needs: test-hepmc3
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download build binaries
      uses: actions/download-artifact@v7
      with:
        name: timeframe-builder-binaries
    - name: Download HepMC3 events
      uses: actions/download-artifact@v7
      with:
        name: hepmc3-merged
    - name: Run EPIC simulation on HepMC3 output
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          source /opt/detector/epic-main/bin/thisepic.sh
          # Run npsim on the merged HepMC3 events
          npsim --compactFile $DETECTOR_PATH/epic_craterlake.xml \
                --inputFiles merged_ci_18x275.hepmc3.tree.root \
                --outputFile sim_ci_18x275.edm4hep.root \
                --numberOfEvents 100
          
          ls -lh sim_ci_18x275.edm4hep.root
    - name: Upload simulated events
      uses: actions/upload-artifact@v6
      with:
        name: epic-simulated
        path: sim_ci_18x275.edm4hep.root
        retention-days: 1

  eicrecon-from-epic:
    needs: epic-simulation
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download EPIC simulated events
      uses: actions/download-artifact@v7
      with:
        name: epic-simulated
    - name: Run eicrecon on simulated events
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          source /opt/detector/epic-main/bin/thisepic.sh
          # Run eicrecon on simulated events from EPIC simulation
          eicrecon -Pplugins=dump_flags sim_ci_18x275.edm4hep.root -Pjana:loglevel=info -Ppodio:output_file=recon_ci_18x275_from_epic.edm4hep.root
          
          ls -lh recon_ci_18x275_from_epic.edm4hep.root 2>/dev/null || echo "Warning: eicrecon output not found"
    - name: Upload reconstructed events
      uses: actions/upload-artifact@v6
      with:
        name: epic-reconstructed
        path: recon_ci_18x275_from_epic.edm4hep.root
        retention-days: 1

  eicrecon-from-edm4hep:
    needs: test-edm4hep
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v6
    - uses: cvmfs-contrib/github-action-cvmfs@v5
    - name: Download EDM4hep merged events
      uses: actions/download-artifact@v7
      with:
        name: edm4hep-merged
    - name: Verify file exists
      run: |
        pwd
        ls -lh
        ls -lh merged_ci_18x275.edm4hep.root
        file merged_ci_18x275.edm4hep.root
    - name: Run eicrecon on EDM4hep merged events
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          source /opt/detector/epic-main/bin/thisepic.sh
          # Verify file exists
          ls -lh merged_ci_18x275.edm4hep.root
          # Run eicrecon directly on merged EDM4hep events
          eicrecon -Pplugins=dump_flags merged_ci_18x275.edm4hep.root -Pjana:loglevel=info -Ppodio:output_file=recon_ci_18x275_from_edm4hep.edm4hep.root
          
          ls -lh recon_ci_18x275_from_edm4hep.edm4hep.root 2>/dev/null || echo "Warning: eicrecon output not found"
    - name: Upload reconstructed events
      uses: actions/upload-artifact@v6
      with:
        name: edm4hep-reconstructed
        path: recon_ci_18x275_from_edm4hep.edm4hep.root
        retention-days: 1

  capybara-report:
    runs-on: ubuntu-24.04
    needs: 
      - eicrecon-from-edm4hep
      - eicrecon-from-epic
    steps:
    - name: Download epic eicrecon outputs
      uses: actions/download-artifact@v7
      with:
        name: epic-reconstructed
    - name: Download edm4hep eicrecon outputs
      uses: actions/download-artifact@v7
      with:
        name: edm4hep-reconstructed
    - name: Generate Capybara report
      uses: eic/run-cvmfs-osg-eic-shell@main
      with:
        platform-release: "eic_xl:nightly"
        run: |
          mkdir capybara-reports
          capybara bara recon_ci_18x275_from_epic.edm4hep.root recon_ci_18x275_from_edm4hep.edm4hep.root
    - name: Upload Capybara report
      uses: actions/upload-artifact@v6
      with:
        name: capybara-report
        path: capybara-reports
        retention-days: 1